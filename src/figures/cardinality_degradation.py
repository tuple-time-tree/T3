from copy import deepcopy

import numpy as np
from matplotlib import pyplot as plt
from scipy.ndimage import gaussian_filter1d

from src.data_collection import DataCollector
from src.database import Database
from src.database_manager import DatabaseManager
from src.figures.infra import (
    setup_matplotlib_latex_font,
    get_hex_color,
    get_figure_path,
    get_figure_format,
)
from src.metrics import q_error
from src.operators import OperatorType
from src.optimizer import optimize_per_tuple_tree_model, BenchmarkedQuery, QueryCategory

ZERO_SHOT_CARD_DEGRADATION = {
    1.0: (1.3077527284622192, 2.2515373706817634, 1.6862062),
    1.1: (1.3089467287063599, 2.2491623401641854, 1.6856866),
    1.2000000000000002: (1.3095659017562866, 2.2476130485534678, 1.6857291),
    1.3000000000000003: (1.3098313808441162, 2.247553730010987, 1.6863861),
    1.4000000000000004: (1.305440068244934, 2.2477277755737313, 1.6859155),
    1.5000000000000004: (1.3027831315994263, 2.2516445159912117, 1.6877172),
    1.6000000000000005: (1.3027255535125732, 2.2537100315094003, 1.6903806),
    1.7000000000000006: (1.3049054145812988, 2.2519811153411875, 1.68809),
    1.8000000000000007: (1.3088008165359497, 2.2560810565948497, 1.6922281),
    1.9000000000000008: (1.305457592010498, 2.254444599151612, 1.6902083),
    2.000000000000001: (1.3078643083572388, 2.2554182529449474, 1.6913662),
    2.100000000000001: (1.3092577457427979, 2.2649818420410166, 1.6917992),
    2.200000000000001: (1.3042384386062622, 2.2684489250183115, 1.693281),
    2.300000000000001: (1.30939519405365, 2.2634838104248054, 1.696547),
    2.4000000000000012: (1.307313323020935, 2.2700418472290047, 1.6912814),
    2.5000000000000013: (1.300318717956543, 2.2766992568969733, 1.6932821),
    2.6000000000000014: (1.3228811025619507, 2.2677700996398933, 1.6938877),
    2.7000000000000015: (1.2977485656738281, 2.2818115234375007, 1.6968358),
    2.8000000000000016: (1.3043510913848877, 2.276784896850587, 1.6904374),
    2.9000000000000017: (1.2925480604171753, 2.2873178005218513, 1.6985351),
    3.0000000000000018: (1.2948966026306152, 2.2731664180755624, 1.6933644),
    3.100000000000002: (1.3133461475372314, 2.284614229202271, 1.6942482),
    3.200000000000002: (1.3121191263198853, 2.284777450561524, 1.7005888),
    3.300000000000002: (1.2945101261138916, 2.277010536193848, 1.7040241),
    3.400000000000002: (1.2955865859985352, 2.2886860370635995, 1.6962148),
    3.500000000000002: (1.2968759536743164, 2.2933343887329105, 1.6925064),
    3.6000000000000023: (1.285510540008545, 2.280659246444703, 1.7028731),
    3.7000000000000024: (1.300626277923584, 2.282009935379029, 1.7032162),
    3.8000000000000025: (1.3040834665298462, 2.283365917205811, 1.7033745),
    3.9000000000000026: (1.3025985956192017, 2.2847119808197025, 1.693039),
    4.000000000000003: (1.3064347505569458, 2.3202939987182623, 1.7038676),
    4.100000000000003: (1.3256045579910278, 2.303437852859498, 1.706353),
    4.200000000000003: (1.305995225906372, 2.3055038928985603, 1.706525),
    4.3000000000000025: (1.2999838590621948, 2.289699459075928, 1.7126229),
    4.400000000000003: (1.3145928382873535, 2.3096431732177742, 1.7072027),
    4.5000000000000036: (1.2877905368804932, 2.3364153861999517, 1.7165309),
    4.600000000000003: (1.3052390813827515, 2.3194444656372073, 1.7165961),
    4.700000000000003: (1.3051379919052124, 2.342843866348267, 1.7190869),
    4.800000000000003: (1.2793415784835815, 2.3184225559234624, 1.7064548),
    4.900000000000004: (1.3240914344787598, 2.3255944728851317, 1.7161324),
    5.0000000000000036: (1.3128142356872559, 2.3524721145629885, 1.7121328),
    5.100000000000003: (1.2988245487213135, 2.3231271743774418, 1.71077),
    5.200000000000004: (1.3008042573928833, 2.3019307613372804, 1.7056903),
    5.300000000000004: (1.2935945987701416, 2.3621576309204104, 1.7192359),
    5.400000000000004: (1.2995117902755737, 2.30625319480896, 1.7114781),
    5.5000000000000036: (1.2818756103515625, 2.3083267688751223, 1.7170368),
    5.600000000000004: (1.3232897520065308, 2.336565113067627, 1.727609),
    5.700000000000005: (1.3023368120193481, 2.3383152484893803, 1.7127872),
    5.800000000000004: (1.2689521312713623, 2.3350540637969974, 1.7157296),
    5.900000000000004: (1.283321738243103, 2.3163739681243896, 1.7169584),
    6.000000000000004: (1.3017381429672241, 2.3382477283477785, 1.7151346),
    6.100000000000005: (1.2841308116912842, 2.3746683597564697, 1.726169),
    6.200000000000005: (1.2732937335968018, 2.3369964122772218, 1.7104155),
    6.300000000000004: (1.3012970685958862, 2.3549066543579107, 1.7191392),
    6.400000000000005: (1.3015246391296387, 2.357757377624512, 1.7226562),
    6.500000000000005: (1.3311313390731812, 2.352920532226563, 1.7259274),
    6.600000000000005: (1.299965262413025, 2.327236366271973, 1.7362707),
    6.700000000000005: (1.273383617401123, 2.40520658493042, 1.7251629),
    6.800000000000005: (1.300567865371704, 2.3306716918945316, 1.7326024),
    6.900000000000006: (1.2864251136779785, 2.3359474658966066, 1.731722),
    7.000000000000005: (1.3011671304702759, 2.377433061599732, 1.7328746),
    7.100000000000005: (1.2748512029647827, 2.415154218673706, 1.7266462),
    7.2000000000000055: (1.3334156274795532, 2.3775255680084233, 1.7305858),
    7.300000000000006: (1.299781084060669, 2.3351306915283208, 1.7330235),
    7.400000000000006: (1.3000231981277466, 2.3676532268524175, 1.7354691),
    7.500000000000005: (1.28277587890625, 2.3345657825469974, 1.7184143),
    7.600000000000006: (1.3029825687408447, 2.3909055233001713, 1.7366474),
    7.700000000000006: (1.3032904863357544, 2.335756254196167, 1.7357539),
    7.800000000000006: (1.3253681659698486, 2.422619724273682, 1.7364926),
    7.900000000000006: (1.2988559007644653, 2.3517540931701664, 1.7391167),
    8.000000000000007: (1.3041698932647705, 2.338864326477051, 1.7403944),
    8.100000000000007: (1.2801992893218994, 2.3817592144012454, 1.7340611),
    8.200000000000006: (1.29884672164917, 2.3604032993316655, 1.7566161),
    8.300000000000006: (1.2986905574798584, 2.3834655284881596, 1.7512144),
    8.400000000000006: (1.2980384826660156, 2.3760593414306648, 1.7478396),
    8.500000000000007: (1.2889961004257202, 2.3696307182312015, 1.738082),
    8.600000000000007: (1.3273707628250122, 2.3463504314422607, 1.7482488),
    8.700000000000006: (1.2891621589660645, 2.376430225372315, 1.747982),
    8.800000000000008: (1.2979402542114258, 2.3885313034057623, 1.7390918),
    8.900000000000007: (1.298736333847046, 2.3512862205505374, 1.7527062),
    9.000000000000007: (1.2937732934951782, 2.384089660644532, 1.7590841),
    9.100000000000007: (1.2974886894226074, 2.3918050765991214, 1.7522751),
    9.200000000000006: (1.2966907024383545, 2.3867529392242437, 1.7593802),
    9.300000000000008: (1.3263057470321655, 2.3576722145080566, 1.7664825),
    9.400000000000007: (1.3120797872543335, 2.359290647506714, 1.7702863),
    9.500000000000007: (1.2989271879196167, 2.3738711357116697, 1.7698203),
    9.600000000000009: (1.2967513799667358, 2.4110710620880127, 1.760572),
    9.700000000000008: (1.3110599517822266, 2.3982809543609624, 1.7699839),
    9.800000000000008: (1.3044164180755615, 2.434389066696167, 1.7712028),
    9.900000000000007: (1.2989983558654785, 2.3963195323944095, 1.7776158),
    10.0: (1.2989954948425293, 2.4432161808013917, 1.7765713),
    11.0: (1.3175742626190186, 2.458857583999635, 1.7885951),
    12.0: (1.2950257062911987, 2.523320531845094, 1.7968637),
    13.0: (1.3155447244644165, 2.6771337509155275, 1.8271389),
    14.0: (1.3621652126312256, 2.814163637161255, 1.8534207),
    15.0: (1.3627790212631226, 2.890117025375367, 1.8872297),
    16.0: (1.3856149911880493, 2.987860441207887, 1.9195709),
    17.0: (1.3751413822174072, 3.095186614990236, 1.9095567),
    18.0: (1.3842275142669678, 3.1763184547424337, 1.9298601),
    19.0: (1.3729922771453857, 3.162647485733033, 1.9687473),
    20.0: (1.3799610137939453, 3.2508446216583264, 1.9812816),
    21.0: (1.3613947629928589, 3.362783336639406, 2.0047364),
    22.0: (1.3739103078842163, 3.391447496414186, 2.0075216),
    23.0: (1.3637722730636597, 3.477596712112428, 2.0331748),
    24.0: (1.4089336395263672, 3.4159636974334724, 2.065265),
    25.0: (1.3999309539794922, 3.5344622611999528, 2.0808294),
    26.0: (1.42438542842865, 3.4909857273101808, 2.1191816),
    27.0: (1.3709783554077148, 3.621252536773683, 2.1168911),
    28.0: (1.3538894653320312, 3.72837929725647, 2.1134908),
    29.0: (1.3498191833496094, 3.6426798820495616, 2.1492894),
    30.0: (1.3389915227890015, 3.7451815128326427, 2.1588905),
    31.0: (1.4286359548568726, 3.6319209575653084, 2.1403067),
    32.0: (1.417350172996521, 3.9224279403686526, 2.1527197),
    33.0: (1.370526671409607, 3.8606873512268076, 2.1597044),
    34.0: (1.394815444946289, 4.00807819366455, 2.1826613),
    35.0: (1.3668255805969238, 3.5537639141082793, 2.1928647),
    36.0: (1.3600956201553345, 3.4748939990997334, 2.2102222),
    37.0: (1.4370009899139404, 4.119523048400879, 2.1757393),
    38.0: (1.3590766191482544, 3.9145845413208034, 2.1471143),
    39.0: (1.3885143995285034, 3.4541110992431667, 2.1299362),
    40.0: (1.3615837097167969, 3.3560411453247108, 2.1599371),
    41.0: (1.3458083868026733, 3.285829877853398, 2.1459594),
    42.0: (1.340319037437439, 3.5119751453399712, 2.186907),
    43.0: (1.406591773033142, 3.5297936439514213, 2.228151),
    44.0: (1.342513918876648, 4.133712863922119, 2.2143521),
    45.0: (1.324212908744812, 3.45003929138184, 2.208622),
    46.0: (1.3461978435516357, 3.1204793930053722, 2.152151),
    47.0: (1.347305178642273, 3.9142629146575936, 2.227849),
    48.0: (1.3447893857955933, 3.155923175811768, 2.086235),
    49.0: (1.3946865797042847, 3.8902690887451175, 2.248046),
    50.0: (1.4517005681991577, 4.030855321884158, 2.2825103),
    51.0: (1.3723869323730469, 3.7633644104003916, 2.1770763),
    52.0: (1.3651354312896729, 3.7288362503051773, 2.2434747),
    53.0: (1.3894680738449097, 3.4772837638854988, 2.1216986),
    54.0: (1.4766390323638916, 3.575741147994996, 2.2062736),
    55.0: (1.394878625869751, 3.6604734897613533, 2.171691),
    56.0: (1.3546497821807861, 3.7043889999389648, 2.1455035),
    57.0: (1.3611631393432617, 4.118565177917483, 2.1712227),
    58.0: (1.4316191673278809, 3.309651041030886, 2.0414877),
    59.0: (1.4603408575057983, 3.6928164005279562, 2.1114824),
    60.0: (1.454195499420166, 3.8663468360900914, 2.2370324),
    61.0: (1.4058802127838135, 3.3712020874023456, 2.0844588),
    62.0: (1.4929343461990356, 3.5808736324310306, 2.202751),
    63.0: (1.3537256717681885, 3.193048095703128, 2.084954),
    64.0: (1.3378112316131592, 3.3059894561767598, 2.081148),
    65.0: (1.45181143283844, 3.894259262084961, 2.2127428),
    66.0: (1.4194196462631226, 4.285033988952637, 2.1807353),
    67.0: (1.422175407409668, 3.2772060871124284, 2.118279),
    68.0: (1.3535292148590088, 3.5480506896972672, 2.0739338),
    69.0: (1.3632121086120605, 3.540335941314699, 2.1119823),
    70.0: (1.3654205799102783, 4.383448410034181, 2.1045165),
    71.0: (1.3603005409240723, 4.336528015136721, 2.1656303),
    72.0: (1.4245611429214478, 3.2241362094879165, 2.052821),
    73.0: (1.3664716482162476, 3.932875204086306, 2.1154735),
    74.0: (1.3558253049850464, 3.5416314601898224, 2.0967355),
    75.0: (1.3535912036895752, 3.9850643634796157, 2.078182),
    76.0: (1.3519527912139893, 3.810316896438599, 2.081423),
    77.0: (1.4477007389068604, 3.8076649188995364, 2.0818121),
    78.0: (1.3721381425857544, 3.9043097496032733, 2.0968857),
    79.0: (1.3949617147445679, 3.5278509140014664, 2.1128895),
    80.0: (1.3543167114257812, 3.3177536487579378, 2.084498),
    81.0: (1.445693016052246, 3.643053197860721, 2.1361907),
    82.0: (1.3790712356567383, 3.526652717590333, 2.059443),
    83.0: (1.3552976846694946, 3.7147669792175297, 2.0587585),
    84.0: (1.367089867591858, 3.779353427886963, 2.175883),
    85.0: (1.4952313899993896, 3.4563364028930668, 2.1253023),
    86.0: (1.4237204790115356, 3.692047405242922, 2.14257),
    87.0: (1.4389967918395996, 3.8058259010314948, 2.1808453),
    88.0: (1.3127514123916626, 3.719451236724854, 2.098843),
    89.0: (1.4389210939407349, 4.25345973968506, 2.1922402),
    90.0: (1.3472471237182617, 3.414699220657351, 2.0714772),
    91.0: (1.3493144512176514, 3.689671659469605, 2.1237645),
    92.0: (1.4207613468170166, 3.4881971359252932, 2.0263865),
    93.0: (1.3278732299804688, 3.5110345363616955, 2.074471),
    94.0: (1.462446928024292, 3.5935035228729255, 2.1116233),
    95.0: (1.3300551176071167, 3.1326547622680687, 1.9703953),
    96.0: (1.418048620223999, 3.3068567752838143, 2.0581203),
    97.0: (1.3726811408996582, 2.9300327777862547, 1.9460617),
    98.0: (1.4210211038589478, 3.2944966793060306, 2.0914779),
    99.0: (1.4931914806365967, 3.736159706115725, 2.1420062),
    100.0: (1.4744484424591064, 3.2402414321899435, 2.0587215),
    110.0: (1.3877346515655518, 3.2431879520416267, 1.9986554),
    120.0: (1.4759228229522705, 3.254004287719727, 2.0442967),
    130.0: (1.4534662961959839, 3.2469547271728514, 1.997435),
    140.0: (1.2876044511795044, 3.300093126296998, 1.9689173),
    150.0: (1.4563814401626587, 3.3887591838836673, 2.1892614),
    160.0: (1.4328409433364868, 3.878610801696778, 2.3146012),
    170.0: (1.5855282545089722, 3.8789744853973405, 2.4657357),
    180.0: (1.6663979291915894, 3.501414918899536, 2.4364843),
    190.0: (1.6991997957229614, 3.443153429031373, 2.285333),
    200.0: (1.622318148612976, 3.3366413116455083, 2.083267),
    210.0: (1.6207212209701538, 3.6971904277801535, 2.249072),
    220.0: (1.7033295631408691, 3.7259655475616467, 2.3883278),
    230.0: (1.6252467632293701, 3.969538307189943, 2.6536422),
    240.0: (1.7154940366744995, 3.6705006122589134, 2.6259968),
    250.0: (1.6147624254226685, 3.3602796554565435, 2.672886),
    260.0: (1.6726967096328735, 3.6858673572540304, 2.6198254),
    270.0: (1.6578304767608643, 3.6219779491424577, 2.3345723),
    280.0: (1.5777587890625, 3.8336109161376957, 2.6462162),
    290.0: (1.8277063369750977, 4.804737663269044, 2.5373762),
    300.0: (1.8881559371948242, 3.765140962600709, 2.4283352),
    310.0: (1.9475867748260498, 5.407153797149659, 2.8706496),
    320.0: (1.7453516721725464, 3.78612689971924, 2.4752548),
    330.0: (1.911798357963562, 3.813133573532108, 2.784236),
    340.0: (2.135672092437744, 6.17354555130005, 3.0547655),
    350.0: (2.159759759902954, 3.9727361679077173, 2.8157988),
    360.0: (2.269024133682251, 5.880977439880375, 3.4357648),
    370.0: (2.043501615524292, 5.863583946228029, 2.6701338),
    380.0: (2.104546308517456, 6.030309867858887, 2.682001),
    390.0: (2.2442002296447754, 6.680260848999027, 3.5935686),
    400.0: (2.3381032943725586, 7.171131896972657, 3.587643),
    410.0: (2.2837107181549072, 5.4090393066406275, 3.2213762),
    420.0: (2.270822525024414, 4.706684017181397, 3.2399685),
    430.0: (2.3209776878356934, 7.737012481689454, 3.484034),
    440.0: (2.0163538455963135, 6.728459644317635, 3.6188774),
    450.0: (2.4144647121429443, 8.192987251281739, 3.4355521),
    460.0: (2.6377527713775635, 8.195956230163574, 4.0345016),
    470.0: (2.5398685932159424, 8.176716613769532, 3.9509547),
    480.0: (2.1865830421447754, 8.69766845703125, 3.9105253),
    490.0: (2.4147658348083496, 7.4101000785827695, 3.6277597),
    500.0: (2.617750644683838, 9.08504161834717, 4.7930346),
    510.0: (2.330172061920166, 8.450200080871587, 4.023774),
    520.0: (2.37748122215271, 7.7497320175170925, 4.386132),
    530.0: (2.7149431705474854, 9.867986106872563, 4.437474),
    540.0: (2.9329311847686768, 6.444698810577396, 4.7556477),
    550.0: (2.6279332637786865, 8.827146530151378, 4.498921),
    560.0: (3.1061806678771973, 7.847522354125977, 4.903247),
    570.0: (2.325057029724121, 10.274264335632326, 4.554071),
    580.0: (2.9778263568878174, 10.276721000671388, 5.0439134),
    590.0: (2.710237741470337, 10.538328361511233, 4.826052),
    600.0: (2.7659778594970703, 10.812596511840821, 5.201287),
    610.0: (3.074105739593506, 11.823957061767594, 4.6388035),
    620.0: (2.539158344268799, 9.264434623718262, 5.014922),
    630.0: (3.0511600971221924, 11.351080703735356, 5.0078897),
    640.0: (2.6000030040740967, 11.319472122192384, 5.4551296),
    650.0: (2.459775924682617, 16.82611846923829, 5.8919635),
    660.0: (2.4730072021484375, 12.220531463623047, 5.594802),
    670.0: (2.4331846237182617, 12.24467105865481, 6.0590434),
    680.0: (3.159611940383911, 11.971407890319824, 5.779765),
    690.0: (3.2098727226257324, 12.367379951477053, 5.231882),
    700.0: (3.663480043411255, 17.015503883361838, 7.129457),
    710.0: (3.3099400997161865, 11.315074920654302, 5.6021304),
    720.0: (2.785370111465454, 12.593932342529298, 6.104652),
    730.0: (3.040203809738159, 11.123119926452638, 5.022114),
    740.0: (3.124249219894409, 13.165056037902836, 6.2064714),
    750.0: (3.0212509632110596, 13.46302700042725, 6.4746227),
    760.0: (2.9067726135253906, 13.704709815979008, 5.88499),
    770.0: (3.698221445083618, 13.991828536987306, 6.4092207),
    780.0: (3.042731761932373, 13.472054862976075, 5.611753),
    790.0: (3.0449881553649902, 15.782350349426286, 5.9866896),
    800.0: (3.916083812713623, 14.085591316223152, 6.151451),
    810.0: (3.6277101039886475, 15.051523017883301, 6.6757874),
    820.0: (3.4274659156799316, 12.773061752319336, 6.364695),
    830.0: (3.8510384559631348, 13.66555557250977, 6.247961),
    840.0: (3.7898683547973633, 10.201416587829595, 6.103053),
    850.0: (3.2622039318084717, 14.929597091674813, 6.310967),
    860.0: (4.04192590713501, 14.637740325927746, 6.560325),
    870.0: (3.895392656326294, 14.416284179687503, 7.608512),
    880.0: (3.281765937805176, 14.199839782714847, 6.58873),
    890.0: (3.5052409172058105, 14.02749710083008, 6.107083),
    900.0: (4.323365211486816, 15.6076665878296, 7.394584),
    910.0: (4.0229315757751465, 14.415982246398928, 7.4199867),
    920.0: (4.436823844909668, 15.047338485717775, 7.932919),
    930.0: (4.269303321838379, 16.889546203613286, 7.3815246),
    940.0: (3.8342151641845703, 15.309342575073245, 7.6324787),
    950.0: (4.489353179931641, 16.307118225097675, 7.872848),
    960.0: (3.959660291671753, 18.54751701354981, 7.5660677),
    970.0: (4.3973307609558105, 18.218085479736363, 8.214273),
    980.0: (4.304565906524658, 15.189065742492676, 8.300028),
    990.0: (4.395545482635498, 16.13775863647461, 7.9582353),
    1000.0: (4.304383754730225, 15.251688957214359, 7.9418674),
    1100.0: (4.143183708190918, 20.605427551269532, 9.7844095),
    1200.0: (5.262494087219238, 19.76719474792481, 8.95263),
    1300.0: (6.006174087524414, 22.739241409301762, 10.610476),
    1400.0: (5.706689834594727, 24.883621215820316, 10.991584),
    1500.0: (6.022982120513916, 26.956055450439454, 12.038065),
    1600.0: (6.348812580108643, 30.144905090332035, 12.693431),
    1700.0: (5.622720241546631, 30.752347946166996, 12.64652),
    1800.0: (7.523252964019775, 33.52683639526367, 14.492906),
    1900.0: (7.271925449371338, 35.86679153442383, 14.3629875),
    2000.0: (6.521547317504883, 37.87239379882813, 16.03992),
    2100.0: (7.270788192749023, 38.345155334472665, 16.38693),
    2200.0: (7.197154998779297, 55.478744506836, 19.994467),
    2300.0: (7.177450656890869, 52.78452911376954, 15.986994),
    2400.0: (7.928805828094482, 45.584633636474614, 19.431591),
    2500.0: (7.820253372192383, 39.86573791503908, 17.338125),
    2600.0: (8.010379791259766, 48.20905227661133, 19.74625),
    2700.0: (8.974763870239258, 48.707908630371115, 20.900677),
    2800.0: (9.175445556640625, 47.292976379394545, 22.675266),
    2900.0: (8.931299209594727, 64.33072052001957, 23.056408),
    3000.0: (10.053668022155762, 62.74370498657234, 23.619352),
    3100.0: (9.650111198425293, 65.32511291503911, 25.28513),
    3200.0: (10.770421981811523, 60.00220184326172, 23.435555),
    3300.0: (11.12794303894043, 63.46707687377932, 27.461977),
    3400.0: (10.26002025604248, 74.97328338623049, 26.49359),
    3500.0: (11.311494827270508, 45.06535949707035, 26.689348),
    3600.0: (10.192124366760254, 68.28651885986329, 26.853712),
    3700.0: (10.016484260559082, 71.5648864746094, 23.869875),
    3800.0: (9.89145565032959, 59.931608581542996, 29.245216),
    3900.0: (11.0442533493042, 80.80032348632817, 25.046837),
    4000.0: (11.578475952148438, 93.20925750732424, 35.440186),
    4100.0: (10.56932258605957, 91.02350006103518, 30.511675),
    4200.0: (10.935871124267578, 86.40470123291024, 32.43099),
    4300.0: (11.202184677124023, 91.89908447265631, 35.48626),
    4400.0: (11.489465713500977, 86.05919494628908, 30.052927),
    4500.0: (10.035239219665527, 80.40508728027349, 30.33732),
    4600.0: (11.729555130004883, 107.44563140869144, 35.161068),
    4700.0: (10.30994987487793, 120.84854583740245, 37.773335),
    4800.0: (14.453990936279297, 91.90482635498047, 39.82137),
    4900.0: (12.02745246887207, 126.05846557617198, 39.25741),
    5000.0: (11.411470413208008, 89.26996154785162, 35.369617),
    5100.0: (13.982925415039062, 100.71409606933598, 39.55068),
    5200.0: (13.840970993041992, 101.11599121093755, 35.156536),
    5300.0: (13.731023788452148, 82.14270477294926, 29.712507),
    5400.0: (14.570555686950684, 90.14801635742201, 39.452686),
    5500.0: (14.26567268371582, 116.52795104980473, 46.822376),
    5600.0: (12.103473663330078, 99.90499572753914, 33.182274),
    5700.0: (12.990506172180176, 95.36738739013673, 43.91876),
    5800.0: (15.539865493774414, 103.44739837646492, 38.32581),
    5900.0: (15.213702201843262, 92.6066009521485, 33.264748),
    6000.0: (15.720314025878906, 88.35873565673839, 38.89828),
    6100.0: (15.864205360412598, 128.86760253906255, 42.402958),
    6200.0: (15.989516258239746, 122.77529907226567, 51.51054),
    6300.0: (15.473122596740723, 111.00405578613288, 45.56723),
    6400.0: (14.628335952758789, 123.12142791748047, 43.738106),
    6500.0: (16.76112174987793, 107.01801605224624, 36.823795),
    6600.0: (17.194089889526367, 120.77970733642593, 49.314896),
    6700.0: (17.581192016601562, 138.40609436035172, 52.613724),
    6800.0: (17.532073974609375, 123.81573181152359, 46.869656),
    6900.0: (19.181583404541016, 122.19195404052743, 47.033577),
    7000.0: (18.046037673950195, 148.42703247070318, 54.61202),
    7100.0: (19.95514488220215, 109.77082824707037, 45.806255),
    7200.0: (18.205995559692383, 126.5305694580079, 48.52589),
    7300.0: (16.7034969329834, 156.08010864257818, 52.031536),
    7400.0: (19.310104370117188, 166.49931945800785, 58.826717),
    7500.0: (18.086050033569336, 161.37549133300791, 56.955402),
    7600.0: (17.387800216674805, 133.4212661743165, 50.14754),
    7700.0: (18.400287628173828, 119.67913665771492, 52.393528),
    7800.0: (20.102094650268555, 175.62622680664066, 57.94686),
    7900.0: (18.876176834106445, 157.39687500000005, 58.64409),
    8000.0: (19.478586196899414, 141.2740966796876, 54.49798),
    8100.0: (18.11819076538086, 202.17102966308616, 64.24421),
    8200.0: (21.454557418823242, 184.75272521972659, 61.22751),
    8300.0: (21.840770721435547, 187.03450012207034, 71.464806),
    8400.0: (20.595245361328125, 194.18870239257822, 71.68006),
    8500.0: (25.00498390197754, 131.8640686035157, 61.008434),
    8600.0: (25.051313400268555, 204.20626525878941, 73.09962),
    8700.0: (22.76959800720215, 174.62445983886727, 60.08342),
    8800.0: (21.168479919433594, 175.70315246582038, 70.157455),
    8900.0: (24.128849029541016, 184.7721923828125, 68.51906),
    9000.0: (23.591094970703125, 194.09219055175794, 62.776264),
    9100.0: (18.8577823638916, 150.0570007324221, 63.58425),
    9200.0: (22.817609786987305, 113.48961334228524, 53.506588),
    9300.0: (19.985002517700195, 186.9004943847657, 63.488827),
    9400.0: (24.691213607788086, 221.15040283203132, 64.4847),
    9500.0: (24.924598693847656, 189.9316986083985, 70.057686),
    9600.0: (25.312114715576172, 169.69153442382827, 75.95032),
    9700.0: (22.185775756835938, 119.4744918823243, 60.458427),
    9800.0: (27.56068229675293, 135.36478576660164, 59.247337),
    9900.0: (26.89303970336914, 215.38345947265637, 80.156456),
    10000.0: (25.026927947998047, 200.09299011230476, 74.52843),
    11000.0: (27.785057067871094, 217.6709289550782, 84.612175),
    12000.0: (32.25867462158203, 271.4296020507813, 87.99735),
    13000.0: (32.821571350097656, 336.3212036132815, 110.582954),
    14000.0: (36.62693786621094, 302.80723876953135, 108.29057),
    15000.0: (43.165733337402344, 324.70926513671884, 109.70179),
    16000.0: (42.142887115478516, 246.31477050781268, 114.04935),
    17000.0: (43.63469314575195, 329.46492309570317, 129.62572),
    18000.0: (41.13041305541992, 419.89761352539085, 129.51602),
    19000.0: (43.36011505126953, 427.9663696289066, 130.38916),
    20000.0: (51.3070068359375, 472.1361389160158, 139.0868),
    21000.0: (57.57253646850586, 476.7691589355469, 178.4523),
    22000.0: (58.05379867553711, 451.20559082031303, 167.28055),
    23000.0: (62.80640411376953, 446.27648315429695, 168.12674),
    24000.0: (63.72711944580078, 419.1322937011723, 138.71864),
    25000.0: (69.67330169677734, 568.046142578125, 203.10764),
    26000.0: (75.41514587402344, 511.9125244140628, 175.59085),
    27000.0: (77.24221801757812, 475.70509033203155, 180.82959),
    28000.0: (74.3873291015625, 604.261218261719, 230.93716),
    29000.0: (76.60966491699219, 571.1619262695316, 218.11214),
    30000.0: (84.02389526367188, 557.1163085937508, 210.73622),
    31000.0: (86.89303588867188, 648.0765991210942, 241.21806),
    32000.0: (81.9964828491211, 485.2246215820316, 176.5309),
    33000.0: (88.55565643310547, 668.1590698242189, 231.73534),
    34000.0: (90.28150939941406, 688.5124511718752, 254.98169),
    35000.0: (104.04790496826172, 872.1167724609385, 295.31693),
    36000.0: (106.56324768066406, 758.562060546875, 243.05997),
    37000.0: (98.38308715820312, 620.4608154296875, 264.27713),
    38000.0: (86.06363677978516, 800.9171020507813, 303.5498),
    39000.0: (103.71633911132812, 702.5081665039069, 303.07272),
    40000.0: (112.67977142333984, 788.4076293945317, 274.11624),
    41000.0: (92.77590942382812, 779.0428344726563, 298.01343),
    42000.0: (124.27879333496094, 726.7452514648444, 267.3113),
    43000.0: (114.38368225097656, 871.6836669921878, 325.2963),
    44000.0: (115.79563903808594, 966.0849975585942, 308.29733),
    45000.0: (118.43304443359375, 680.829028320313, 306.47406),
    46000.0: (136.72360229492188, 970.3134033203125, 326.88184),
    47000.0: (139.04171752929688, 1016.7691284179692, 349.10434),
    48000.0: (100.8335189819336, 844.7484741210943, 315.88785),
    49000.0: (141.9125213623047, 862.3577392578131, 370.98654),
    50000.0: (137.6495361328125, 1172.5720703125005, 374.5648),
    51000.0: (150.85191345214844, 1209.508837890627, 416.03314),
    52000.0: (171.10910034179688, 1348.709277343751, 431.44907),
    53000.0: (140.94337463378906, 756.8742309570322, 368.7022),
    54000.0: (142.17616271972656, 1049.8060546875001, 364.95798),
    55000.0: (144.81398010253906, 1252.5900146484375, 387.31332),
    56000.0: (190.7226104736328, 995.7020385742195, 392.68256),
    57000.0: (156.97703552246094, 1203.2333251953125, 417.64206),
    58000.0: (157.1074676513672, 1024.376965332032, 434.2837),
    59000.0: (151.0404815673828, 1395.642260742188, 467.25006),
    60000.0: (165.25997924804688, 1318.3223144531255, 535.31744),
    61000.0: (175.37945556640625, 1077.4729980468758, 460.23972),
    62000.0: (164.94142150878906, 1242.0563720703133, 384.74542),
    63000.0: (184.11126708984375, 1253.9691406250006, 488.13235),
    64000.0: (219.38262939453125, 1232.9594482421878, 470.73697),
    65000.0: (193.132080078125, 1235.1960205078126, 419.08438),
    66000.0: (192.91659545898438, 1348.2991455078131, 545.918),
    67000.0: (190.02578735351562, 1472.4241210937507, 526.4354),
    68000.0: (174.05616760253906, 1196.9332275390634, 489.6565),
    69000.0: (190.10765075683594, 1219.064697265626, 499.92853),
    70000.0: (202.6337432861328, 1149.8555175781253, 451.53195),
    71000.0: (201.4887237548828, 1441.506567382813, 596.60645),
    72000.0: (195.50064086914062, 1520.8448730468751, 528.62775),
    73000.0: (192.31005859375, 1225.8988281250001, 489.41534),
    74000.0: (212.894287109375, 1626.5274414062508, 566.6415),
    75000.0: (191.96043395996094, 1639.235815429688, 558.1722),
    76000.0: (218.6657257080078, 1661.144506835938, 611.8646),
    77000.0: (228.7510986328125, 1668.0429931640633, 585.3813),
    78000.0: (207.60308837890625, 1647.890185546875, 628.9737),
    79000.0: (234.68629455566406, 1656.9808349609389, 577.8307),
    80000.0: (220.4768524169922, 1687.8358886718763, 561.246),
    81000.0: (234.44154357910156, 1916.5700927734383, 610.46967),
    82000.0: (218.2682647705078, 1558.301123046875, 603.0424),
    83000.0: (240.2248992919922, 1814.500708007813, 638.2928),
    84000.0: (248.28749084472656, 1846.6730224609382, 563.0173),
    85000.0: (241.60533142089844, 1927.3189941406267, 624.19855),
    86000.0: (248.90011596679688, 1821.1806640625055, 657.096),
    87000.0: (197.9306640625, 1743.582617187501, 558.8717),
    88000.0: (261.3941345214844, 1787.4696289062506, 682.66895),
    89000.0: (245.32443237304688, 1366.6144775390637, 656.9243),
    90000.0: (238.29783630371094, 1978.7597900390633, 670.843),
    91000.0: (250.84613037109375, 1296.9487060546892, 529.5694),
    92000.0: (245.08180236816406, 2004.7927978515636, 782.2538),
    93000.0: (253.04241943359375, 1256.4541503906257, 516.15985),
    94000.0: (247.74777221679688, 2207.3949218750013, 699.54785),
    95000.0: (258.5086364746094, 2058.804589843751, 695.3905),
    96000.0: (277.8157958984375, 1906.8443115234388, 660.559),
    97000.0: (255.6691131591797, 2199.9173828125017, 833.0741),
    98000.0: (283.5992126464844, 1613.6521240234379, 604.49066),
    99000.0: (272.9330749511719, 1908.0312988281255, 690.52747),
    100000.0: (272.1658630371094, 2366.460742187501, 768.4245),
    1000000.0: (2650.3115234375, 12545.251171875017, 5272.833),
    10000000.0: (34501.640625, 203502.91875000007, 73153.18),
    100000000.0: (266620.03125, 2281609.4000000004, 721292.56),
    1000000000.0: (2758042.75, 18106254.40000003, 7712528.0),
}


def split_databases(name: str) -> tuple[list[Database], list[Database]]:
    special_databases = {"tpch": ["tpchSf1", "tpchSf10", "tpchSf100"], "tpcds": ["tpcdsSf1", "tpcdsSf10", "tpcdsSf100"]}
    test_names = [name]
    if name in special_databases:
        test_names = special_databases[name]
    test_databases = []
    train_databases = []
    dbs = DatabaseManager.get_all_databases()
    dbs.sort(key=lambda x: x.schema.name)
    for db in dbs:
        if db.schema.name in test_names:
            test_databases.append(db)
        else:
            train_databases.append(db)
    return train_databases, test_databases


def get_card_error_tree(original_query: BenchmarkedQuery, expected_q_error: float):
    query = deepcopy(original_query)
    query.feature_matrix = None
    current_factor = expected_q_error
    if np.random.choice([True, False]):
        current_factor = 1 / current_factor
    for _, op in query.query_plan.operators.items():
        if op.type != OperatorType.TableScan:
            op.input_cardinality *= current_factor
        # Group bys which return a single tuple will always be estimated correctly
        if op.type != OperatorType.GroupBy and op.output_cardinality != 1:
            op.output_cardinality *= current_factor
        if op.right_input_cardinality is not None:
            op.right_input_cardinality *= current_factor
    return query


def compute_card_degen():
    train, test = split_databases("job")
    test_benchmarks = DataCollector.collect_benchmarks(test, False, query_category=[QueryCategory.fixed])

    train_lim_benchmarks = DataCollector.collect_benchmarks(
        train, False, query_category=[QueryCategory.complex_select_join_simple_agg]
    )
    model = optimize_per_tuple_tree_model(train_lim_benchmarks)

    p50s = []
    p90s = []
    avgs = []

    errs = np.hstack(
        [
            np.arange(1.0, 10, 0.1),
            np.arange(10, 100, 1),
            np.arange(100, 1000, 10),
            np.arange(1000, 10000, 100),
        ]
    )
    print("Computing accuracy with degenerated cardinalities...")
    for q_err in errs:
        err_queries = []
        for q in test_benchmarks:
            err_queries.append(get_card_error_tree(q, q_err))

        runtimes = [b.get_total_runtime() for b in err_queries]
        estimates = [model.estimate_runtime(b) for b in err_queries]
        q_errors = [q_error(e, r) for e, r in zip(estimates, runtimes)]
        p50s.append(np.quantile(q_errors, 0.5))
        p90s.append(np.quantile(q_errors, 0.9))
        avgs.append(np.average(q_errors))

    stats = {}
    for err, p50, p90, avg in zip(errs, p50s, p90s, avgs):
        stats[float(err)] = (float(p50), float(p90), float(avg))
    return stats


def plot_card_degen(stats: dict[float, tuple[float, float, float]]):
    setup_matplotlib_latex_font()
    fig, ax = plt.subplots(1, 1, figsize=(6, 3))

    card_errs = np.hstack(
        [
            np.arange(1.0, 10, 0.1),
            np.arange(10, 100, 1),
            np.arange(100, 1000, 10),
            np.arange(1000, 10000, 100),
        ]
    )
    t3_errs_p50 = [stats[x][0] for x in card_errs]
    t3_errs_p90 = [stats[x][1] for x in card_errs]
    t3_errs_avg = [stats[x][2] for x in card_errs]

    zero_shot_errs_p50 = [ZERO_SHOT_CARD_DEGRADATION[x][0] for x in card_errs]
    zero_shot_errs_p90 = [ZERO_SHOT_CARD_DEGRADATION[x][1] for x in card_errs]
    zero_shot_errs_avg = [ZERO_SHOT_CARD_DEGRADATION[x][2] for x in card_errs]

    smoothing = 2
    t3_errs_p50_smooth = gaussian_filter1d(t3_errs_p50, smoothing)
    t3_errs_p90_smooth = gaussian_filter1d(t3_errs_p90, smoothing)
    t3_errs_avg_smooth = gaussian_filter1d(t3_errs_avg, smoothing)

    zero_shot_errs_p50_smooth = gaussian_filter1d(zero_shot_errs_p50, smoothing)
    zero_shot_errs_p90_smooth = gaussian_filter1d(zero_shot_errs_p90, smoothing)
    zero_shot_errs_avg_smooth = gaussian_filter1d(zero_shot_errs_avg, smoothing)

    ax.plot(card_errs, t3_errs_p50, color=get_hex_color("my_blue"))
    ax.plot(card_errs, t3_errs_p90, color=get_hex_color("my_blue"))
    ax.plot(card_errs, t3_errs_avg, color=get_hex_color("my_blue"))

    ax.plot(card_errs, zero_shot_errs_p50, color=get_hex_color("my_red"))
    ax.plot(card_errs, zero_shot_errs_p90, color=get_hex_color("my_red"))
    ax.plot(card_errs, zero_shot_errs_avg, color=get_hex_color("my_red"))

    plt.text(1.1e4, t3_errs_p50_smooth[-1], "p50", ha="left", va="center", size=11, color="black")
    plt.text(1.1e4, t3_errs_p90_smooth[-1], "p90", ha="left", va="center", size=11, color="black")
    plt.text(1.1e4, t3_errs_avg_smooth[-1], "avg", ha="left", va="center", size=11, color="black")

    plt.text(1.1e4, zero_shot_errs_p50_smooth[-1], "p50", ha="left", va="center", size=11, color="black")
    plt.text(1.1e4, zero_shot_errs_p90_smooth[-1], "p90", ha="left", va="center", size=11, color="black")
    plt.text(1.1e4, zero_shot_errs_avg_smooth[-1], "avg", ha="left", va="center", size=11, color="black")

    plt.text(4e3, 1.6, "T3", size=12, color="black")
    plt.text(5e2, 60, "Zero Shot", size=12, color="black")

    ax.set_xlabel("Cardinality Estimation Error (Q-Error, Log Scale)")
    ax.set_ylabel("Prediction Error\n(Q-Error, Log Scale)")

    ax.set_xscale("log")
    ax.set_yscale("log")

    ax.set_xlim(1, 2e4)
    ax.set_ylim(1, 286)

    plt.xticks([1, 1e1, 1e2, 1e3, 1e4])
    plt.yticks([1, 1e1, 1e2])
    plt.tick_params(axis="x", which="minor", bottom=False)
    plt.tick_params(axis="y", which="minor", left=False)

    plt.savefig(f"{get_figure_path()}/card_degradation.{get_figure_format()}", bbox_inches="tight")


def make_card_degen_figure():
    stats = compute_card_degen()
    plot_card_degen(stats)


def main():
    make_card_degen_figure()


if __name__ == "__main__":
    main()
